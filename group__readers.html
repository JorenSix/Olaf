<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.6"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Olaf: Reader Lock Table</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Olaf
   </div>
   <div id="projectbrief">Overly Lightweight Acoustic Fingerprinting</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.6 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="summary">
<a href="#nested-classes">Data Structures</a> &#124;
<a href="#define-members">Macros</a> &#124;
<a href="#typedef-members">Typedefs</a> &#124;
<a href="#enum-members">Enumerations</a>  </div>
  <div class="headertitle"><div class="title">Reader Lock Table<div class="ingroups"><a class="el" href="group__internal.html">LMDB Internals</a></div></div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="nested-classes" name="nested-classes"></a>
Data Structures</h2></td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_m_d_b__rxbody.html">MDB_rxbody</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_m_d_b__reader.html">MDB_reader</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_m_d_b__txbody.html">MDB_txbody</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:"><td class="memItemLeft" align="right" valign="top">struct &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="struct_m_d_b__txninfo.html">MDB_txninfo</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="define-members" name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:gadff1f7b4d4626610a8d616e0c6dbbea4"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gadff1f7b4d4626610a8d616e0c6dbbea4">DEFAULT_READERS</a>&#160;&#160;&#160;126</td></tr>
<tr class="separator:gadff1f7b4d4626610a8d616e0c6dbbea4"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa62717a1fae2c57f94f2a9b8ae08ec49"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gaa62717a1fae2c57f94f2a9b8ae08ec49">CACHELINE</a>&#160;&#160;&#160;64</td></tr>
<tr class="separator:gaa62717a1fae2c57f94f2a9b8ae08ec49"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gabb6423d38a9132eedb4f2e2be72b8aeb"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gabb6423d38a9132eedb4f2e2be72b8aeb">MDB_LOCK_FORMAT</a></td></tr>
<tr class="separator:gabb6423d38a9132eedb4f2e2be72b8aeb"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa1cbebae0628ac64b0f4b8a01cf3347c"><td class="memItemLeft" align="right" valign="top">#define&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gaa1cbebae0628ac64b0f4b8a01cf3347c">MDB_LOCK_TYPE</a></td></tr>
<tr class="separator:gaa1cbebae0628ac64b0f4b8a01cf3347c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="typedef-members" name="typedef-members"></a>
Typedefs</h2></td></tr>
<tr class="memitem:ga1b638ba7d908ba5cc311f53f12a33bc1"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct_m_d_b__rxbody.html">MDB_rxbody</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#ga1b638ba7d908ba5cc311f53f12a33bc1">MDB_rxbody</a></td></tr>
<tr class="separator:ga1b638ba7d908ba5cc311f53f12a33bc1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga7fadcf9a025565550af70dfd4cdc76fd"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct_m_d_b__reader.html">MDB_reader</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#ga7fadcf9a025565550af70dfd4cdc76fd">MDB_reader</a></td></tr>
<tr class="separator:ga7fadcf9a025565550af70dfd4cdc76fd"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaf1d14a8d8385e5feee0d41b4c31cb7a7"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct_m_d_b__txbody.html">MDB_txbody</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#gaf1d14a8d8385e5feee0d41b4c31cb7a7">MDB_txbody</a></td></tr>
<tr class="separator:gaf1d14a8d8385e5feee0d41b4c31cb7a7"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga5fa5bdbee68fd44c0aef98bee22c837c"><td class="memItemLeft" align="right" valign="top">typedef struct <a class="el" href="struct_m_d_b__txninfo.html">MDB_txninfo</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__readers.html#ga5fa5bdbee68fd44c0aef98bee22c837c">MDB_txninfo</a></td></tr>
<tr class="separator:ga5fa5bdbee68fd44c0aef98bee22c837c"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="enum-members" name="enum-members"></a>
Enumerations</h2></td></tr>
<tr class="memitem:ga06fc87d81c62e9abb8790b6e5713c55b"><td class="memItemLeft" align="right" valign="top">enum &#160;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="group__readers.html#gga06fc87d81c62e9abb8790b6e5713c55ba83032fe0d3f4bb73d2606bc67407771a">MDB_lock_desc</a>
 }</td></tr>
<tr class="separator:ga06fc87d81c62e9abb8790b6e5713c55b"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p>Readers don't acquire any locks for their data access. Instead, they simply record their transaction ID in the reader table. The reader mutex is needed just to find an empty slot in the reader table. The slot's address is saved in thread-specific data so that subsequent read transactions started by the same thread need no further locking to proceed.</p>
<p>If #MDB_NOTLS is set, the slot address is not saved in thread-specific data.</p>
<p>No reader table is used if the database is on a read-only filesystem, or if #MDB_NOLOCK is set.</p>
<p>Since the database uses multi-version concurrency control, readers don't actually need any locking. This table is used to keep track of which readers are using data from which old transactions, so that we'll know when a particular old transaction is no longer in use. Old transactions that have discarded any data pages can then have those pages reclaimed for use by a later write transaction.</p>
<p>The lock table is constructed such that reader slots are aligned with the processor's cache line size. Any slot is only ever used by one thread. This alignment guarantees that there will be no contention or cache thrashing as threads update their own slot info, and also eliminates any need for locking when accessing a slot.</p>
<p>A writer thread will scan every slot in the table to determine the oldest outstanding reader transaction. Any freed pages older than this will be reclaimed by the writer. The writer doesn't use any locks when scanning this table. This means that there's no guarantee that the writer will see the most up-to-date reader info, but that's not required for correct operation - all we need is to know the upper bound on the oldest reader, we don't care at all about the newest reader. So the only consequence of reading stale information here is that old pages might hang around a while longer before being reclaimed. That's actually good anyway, because the longer we delay reclaiming old pages, the more likely it is that a string of contiguous pages can be found after coalescing old pages from many old transactions together. </p>
<h2 class="groupheader">Macro Definition Documentation</h2>
<a id="gaa62717a1fae2c57f94f2a9b8ae08ec49" name="gaa62717a1fae2c57f94f2a9b8ae08ec49"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa62717a1fae2c57f94f2a9b8ae08ec49">&#9670;&#160;</a></span>CACHELINE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CACHELINE&#160;&#160;&#160;64</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The size of a CPU cache line in bytes. We want our lock structures aligned to this size to avoid false cache line sharing in the lock table. This value works for most CPUs. For Itanium this should be 128. </p>

</div>
</div>
<a id="gadff1f7b4d4626610a8d616e0c6dbbea4" name="gadff1f7b4d4626610a8d616e0c6dbbea4"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gadff1f7b4d4626610a8d616e0c6dbbea4">&#9670;&#160;</a></span>DEFAULT_READERS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_READERS&#160;&#160;&#160;126</td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Number of slots in the reader table. This value was chosen somewhat arbitrarily. 126 readers plus a couple mutexes fit exactly into 8KB on my development machine. Applications should set the table size using mdb_env_set_maxreaders(). </p>

</div>
</div>
<a id="gabb6423d38a9132eedb4f2e2be72b8aeb" name="gabb6423d38a9132eedb4f2e2be72b8aeb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gabb6423d38a9132eedb4f2e2be72b8aeb">&#9670;&#160;</a></span>MDB_LOCK_FORMAT</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MDB_LOCK_FORMAT</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">    ((uint32_t)         \</div>
<div class="line">     (((<a class="code hl_define" href="group__internal.html#ga1d56e55199f31cd585300a2b73c22d82">MDB_LOCK_VERSION</a>) % (1U &lt;&lt; <a class="code hl_define" href="group__internal.html#gad2eb93c96a75f89f36e07af3dfa5fcaa">MDB_LOCK_VERSION_BITS</a>)) \</div>
<div class="line">      + <a class="code hl_enumvalue" href="group__readers.html#gga06fc87d81c62e9abb8790b6e5713c55ba83032fe0d3f4bb73d2606bc67407771a">MDB_lock_desc</a>     * (1U &lt;&lt; <a class="code hl_define" href="group__internal.html#gad2eb93c96a75f89f36e07af3dfa5fcaa">MDB_LOCK_VERSION_BITS</a>)))</div>
<div class="ttc" id="agroup__internal_html_ga1d56e55199f31cd585300a2b73c22d82"><div class="ttname"><a href="group__internal.html#ga1d56e55199f31cd585300a2b73c22d82">MDB_LOCK_VERSION</a></div><div class="ttdeci">#define MDB_LOCK_VERSION</div><div class="ttdef"><b>Definition:</b> mdb.c:636</div></div>
<div class="ttc" id="agroup__internal_html_gad2eb93c96a75f89f36e07af3dfa5fcaa"><div class="ttname"><a href="group__internal.html#gad2eb93c96a75f89f36e07af3dfa5fcaa">MDB_LOCK_VERSION_BITS</a></div><div class="ttdeci">#define MDB_LOCK_VERSION_BITS</div><div class="ttdef"><b>Definition:</b> mdb.c:640</div></div>
<div class="ttc" id="agroup__readers_html_gga06fc87d81c62e9abb8790b6e5713c55ba83032fe0d3f4bb73d2606bc67407771a"><div class="ttname"><a href="group__readers.html#gga06fc87d81c62e9abb8790b6e5713c55ba83032fe0d3f4bb73d2606bc67407771a">MDB_lock_desc</a></div><div class="ttdeci">@ MDB_lock_desc</div><div class="ttdef"><b>Definition:</b> mdb.c:935</div></div>
</div><!-- fragment --><p>Lockfile format signature: version, features and field layout </p>

</div>
</div>
<a id="gaa1cbebae0628ac64b0f4b8a01cf3347c" name="gaa1cbebae0628ac64b0f4b8a01cf3347c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaa1cbebae0628ac64b0f4b8a01cf3347c">&#9670;&#160;</a></span>MDB_LOCK_TYPE</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MDB_LOCK_TYPE</td>
        </tr>
      </table>
</div><div class="memdoc">
<b>Value:</b><div class="fragment"><div class="line">        (10 + \</div>
<div class="line">        LOG2_MOD(<a class="code hl_define" href="group__internal.html#gaa1b989dd4a56a3d7d4b0b81feb0eaacd">ALIGNOF2</a>(pthread_mutex_t), 5) + \</div>
<div class="line">        sizeof(pthread_mutex_t) / 4U % 22 * 5)</div>
<div class="ttc" id="agroup__internal_html_gaa1b989dd4a56a3d7d4b0b81feb0eaacd"><div class="ttname"><a href="group__internal.html#gaa1b989dd4a56a3d7d4b0b81feb0eaacd">ALIGNOF2</a></div><div class="ttdeci">#define ALIGNOF2(type)</div><div class="ttdef"><b>Definition:</b> mdb.c:716</div></div>
</div><!-- fragment --><p>Lock type and layout. Values 0-119. _WIN32 implies <a class="el" href="group__compat.html#ga074373701b95aeaf38530ad7f9970030">MDB_PIDLOCK</a>. Some low values are reserved for future tweaks. </p>

</div>
</div>
<h2 class="groupheader">Typedef Documentation</h2>
<a id="ga7fadcf9a025565550af70dfd4cdc76fd" name="ga7fadcf9a025565550af70dfd4cdc76fd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga7fadcf9a025565550af70dfd4cdc76fd">&#9670;&#160;</a></span>MDB_reader</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct_m_d_b__reader.html">MDB_reader</a> <a class="el" href="struct_m_d_b__reader.html">MDB_reader</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The actual reader record, with cacheline padding. </p>

</div>
</div>
<a id="ga1b638ba7d908ba5cc311f53f12a33bc1" name="ga1b638ba7d908ba5cc311f53f12a33bc1"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga1b638ba7d908ba5cc311f53f12a33bc1">&#9670;&#160;</a></span>MDB_rxbody</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct_m_d_b__rxbody.html">MDB_rxbody</a> <a class="el" href="struct_m_d_b__rxbody.html">MDB_rxbody</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The information we store in a single slot of the reader table. In addition to a transaction ID, we also record the process and thread ID that owns a slot, so that we can detect stale information, e.g. threads or processes that went away without cleaning up. </p><dl class="section note"><dt>Note</dt><dd>We currently don't check for stale records. We simply re-init the table when we know that we're the only process opening the lock file. </dd></dl>

</div>
</div>
<a id="gaf1d14a8d8385e5feee0d41b4c31cb7a7" name="gaf1d14a8d8385e5feee0d41b4c31cb7a7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaf1d14a8d8385e5feee0d41b4c31cb7a7">&#9670;&#160;</a></span>MDB_txbody</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct_m_d_b__txbody.html">MDB_txbody</a> <a class="el" href="struct_m_d_b__txbody.html">MDB_txbody</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The header for the reader table. The table resides in a memory-mapped file. (This is a different file than is used for the main database.)</p>
<p>For POSIX the actual mutexes reside in the shared memory of this mapped file. On Windows, mutexes are named objects allocated by the kernel; we store the mutex names in this mapped file so that other processes can grab them. This same approach is also used on MacOSX/Darwin (using named semaphores) since MacOSX doesn't support process-shared POSIX mutexes. For these cases where a named object is used, the object name is derived from a 64 bit FNV hash of the environment pathname. As such, naming collisions are extremely unlikely. If a collision occurs, the results are unpredictable. </p>

</div>
</div>
<a id="ga5fa5bdbee68fd44c0aef98bee22c837c" name="ga5fa5bdbee68fd44c0aef98bee22c837c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga5fa5bdbee68fd44c0aef98bee22c837c">&#9670;&#160;</a></span>MDB_txninfo</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">typedef struct <a class="el" href="struct_m_d_b__txninfo.html">MDB_txninfo</a> <a class="el" href="struct_m_d_b__txninfo.html">MDB_txninfo</a></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>The actual reader table definition. </p>

</div>
</div>
<h2 class="groupheader">Enumeration Type Documentation</h2>
<a id="ga06fc87d81c62e9abb8790b6e5713c55b" name="ga06fc87d81c62e9abb8790b6e5713c55b"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga06fc87d81c62e9abb8790b6e5713c55b">&#9670;&#160;</a></span>anonymous enum</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div><div class="memdoc">
<table class="fieldtable">
<tr><th colspan="2">Enumerator</th></tr><tr><td class="fieldname"><a id="gga06fc87d81c62e9abb8790b6e5713c55ba83032fe0d3f4bb73d2606bc67407771a" name="gga06fc87d81c62e9abb8790b6e5713c55ba83032fe0d3f4bb73d2606bc67407771a"></a>MDB_lock_desc&#160;</td><td class="fielddoc"><p>Magic number for lockfile layout and features. </p><pre class="fragment">This *attempts* to stop liblmdb variants compiled with conflicting
options from using the lockfile at the same time and thus breaking
it.  It describes locking types, and sizes and sometimes alignment
of the various lockfile items.

The detected ranges are mostly guesswork, or based simply on how
big they could be without using more bits.  So we can tweak them
in good conscience when updating #MDB_LOCK_VERSION.
</pre> </td></tr>
</table>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.6
</small></address>
</body>
</html>
